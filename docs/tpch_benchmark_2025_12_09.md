# VortexLake TPC-H Benchmark

## 概述

### 本次更新与优化点（2025-12-09）
- 增加 filter pushdown 到 file scanner，减少无关数据读取。
- 为 TableProvider 提供统计信息，在运行时传递给 DataFusion，优化 join 代价估计与计划选择。
- 预期效果：I/O 剪枝更积极，join 计划更合理，多表查询性能提升。

本文档记录 VortexLake 与 Parquet 在 TPC-H 基准测试中的性能对比。TPC-H 是决策支持系统的行业标准基准测试，包含 8 个表和 22 个分析查询。

> 通用模型、表结构、查询 SQL 及运行方式请参见 `tpch_benchmark_common.md`。

## 测试环境

- **数据规模**: Scale Factor 0.1 (约 60MB 原始数据)
- **数据格式**: 
  - Parquet (Apache Parquet, 默认压缩)
  - VortexLake (Apache Vortex 格式, FastLanes + Bitpacking)
- **查询引擎**: Apache DataFusion 50.x
- **测试日期**: 2025-12-09

## 存储性能

| 格式 | 大小 | 压缩比 | 写入时间 |
|------|------|--------|----------|
| Parquet | 54.85 MB | 1.00x | 5,010.69 ms |
| VortexLake | 27.69 MB | **0.50x** | 12,924.94 ms |

**结论**: VortexLake 存储空间节省 **50%**，写入时间约 2.6x。

## 测试结果 (SF=0.1)

### 数据规模

| 表 | 行数 |
|----|------|
| region | 5 |
| nation | 25 |
| supplier | 1,000 |
| customer | 15,000 |
| part | 20,000 |
| partsupp | 80,000 |
| orders | 150,000 |
| lineitem | 600,572 |

### 存储性能

| 指标 | Parquet | VortexLake | 比值 |
|------|---------|------------|------|
| **存储大小** | 54.85 MB | 27.69 MB | **0.50x** ✓ |
| **写入时间** | 5,010.69 ms | 12,924.94 ms | 2.58x |

### 完整测试结果 (SF=0.1, 22个查询)

| Query | 描述 | Parquet (ms) | VortexLake (ms) | Speedup | 状态 |
|-------|------|-------------|-----------------|---------|------|
| **Q1** | 价格汇总 | 1,074.69 | 987.73 | **1.09x** | ✓ PASS |
| **Q2** | 最低成本供应商 | 145.21 | 126.24 | **1.15x** | ✓ PASS |
| **Q3** | 配送优先级 | 258.91 | 214.44 | **1.21x** | ✓ PASS |
| **Q4** | 订单优先级 | 227.54 | 161.47 | **1.41x** | ✓ PASS |
| **Q5** | 本地供应商 | 284.26 | 218.64 | **1.30x** | ✓ PASS |
| **Q6** | 收入预测 | 200.43 | 121.81 | **1.65x** | ✓ PASS |
| **Q7** | 体量运输 | 480.54 | 394.86 | **1.22x** | ✓ PASS |
| **Q8** | 国家市场份额 | 340.10 | 254.03 | **1.34x** | ✓ PASS |
| **Q9** | 产品利润 | 574.00 | 381.06 | **1.51x** | ✓ PASS |
| **Q10** | 退货报告 | 455.17 | 422.61 | **1.08x** | ✓ PASS |
| **Q11** | 重要库存识别 | 119.09 | 97.98 | **1.22x** | ✓ PASS |
| **Q12** | 配送模式 | 453.52 | 218.32 | **2.08x** | ✓ PASS |
| **Q13** | 客户分布 | 373.55 | 418.81 | 0.89x | ✓ PASS |
| **Q14** | 促销效果 | 205.49 | 131.78 | **1.56x** | ✓ PASS |
| **Q15** | 顶级供应商 | 337.63 | 218.34 | **1.55x** | ✓ PASS |
| **Q16** | 零件/供应商关系 | 153.12 | 131.66 | **1.16x** | ✓ PASS |
| **Q17** | 小订单收入 | 398.08 | 554.84 | 0.72x | ✓ PASS |
| **Q18** | 大订单客户 | 905.30 | 810.95 | **1.12x** | ✓ PASS |
| **Q19** | 折扣收入 | 501.25 | 220.89 | **2.27x** | ✓ PASS |
| **Q20** | 潜在零件促销 | 305.41 | 252.54 | **1.21x** | ✓ PASS |
| **Q21** | 供应商等待 | 720.73 | 509.52 | **1.41x** | ✓ PASS |
| **Q22** | 全球销售机会 | 150.53 | 138.89 | **1.08x** | ✓ PASS |

### 性能分类

#### VortexLake 显著更快 (>1.5x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q19 | **2.27x** | 复杂 OR 谓词 + 聚合 |
| Q12 | **2.08x** | 2表JOIN + 条件聚合 |
| Q6  | **1.65x** | 单表过滤聚合 |
| Q14 | **1.56x** | 2表JOIN + CASE聚合 |
| Q15 | **1.55x** | 2表JOIN |
| Q9  | **1.51x** | 6表JOIN + LIKE 过滤 |

#### VortexLake 略快或相当 (0.9x-1.5x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q1 | 1.09x | 单表聚合 |
| Q2 | 1.15x | 5表JOIN |
| Q3 | 1.21x | 3表JOIN |
| Q4 | 1.41x | EXISTS子查询 |
| Q5 | 1.30x | 6表JOIN |
| Q7 | 1.22x | 5表JOIN |
| Q8 | 1.34x | 7表JOIN + 过滤 |
| Q10 | 1.08x | 4表JOIN |
| Q11 | 1.22x | HAVING子查询 |
| Q16 | 1.16x | NOT IN 场景 |
| Q18 | 1.12x | IN子查询 + 聚合 |
| Q20 | 1.21x | 嵌套子查询 |
| Q21 | 1.41x | EXISTS + NOT EXISTS |
| Q22 | 1.08x | NOT EXISTS 场景 |

#### Parquet 更快 (<0.9x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q17 | 0.72x | 相关子查询 |
| Q13 | 0.89x | LEFT JOIN + 过滤 |

## 性能分析

### VortexLake 显著优势场景 (>1.5x)

| Query | Speedup | 分析 |
|-------|---------|------|
| **Q19** | 2.27x | 复杂 OR 谓词，filter pushdown 高效剪枝 |
| **Q12** | 2.08x | 2表JOIN + 条件聚合，Zone Map 生效 |
| **Q6** | 1.65x | 单表过滤聚合，filter pushdown 效果显著 |
| **Q14** | 1.56x | CASE聚合 + 日期范围过滤 |
| **Q15** | 1.55x | CTE + 聚合 |
| **Q9** | 1.51x | 6表JOIN + LIKE过滤，压缩减少I/O |

**共同特点**: 
- 有明确的过滤条件（日期范围、LIKE、IN、OR等）
- filter pushdown 到 file scanner 减少读取
- Zone Map 可以有效剪枝
- 聚合操作受益于压缩

### VortexLake 劣势场景 (<0.9x)

| Query | Speedup | 分析 |
|-------|---------|------|
| **Q17** | 0.72x | 相关子查询，每行都需要子查询执行 |
| **Q13** | 0.89x | LEFT JOIN + LIKE 过滤，外连接场景 |

**共同特点**:
- 相关子查询（correlated subquery）开销大
- LEFT JOIN 场景优化空间有限

### 综合评估

| 方面 | Parquet | VortexLake | 结论 |
|------|---------|------------|------|
| **存储效率** | 54.85 MB | 27.69 MB | VortexLake 节省 **50%** 空间 ✓ |
| **写入性能** | 5.0s | 12.9s | Parquet 仍更快 |
| **单表查询** | 基准 | 1.09x-1.65x | VortexLake 更快 ✓ |
| **2表JOIN** | 基准 | 1.08x-2.27x | VortexLake 明显更快 ✓ |
| **3-4表JOIN** | 基准 | 1.08x-1.41x | VortexLake 更快 ✓ |
| **5+表JOIN** | 基准 | 1.12x-1.34x | VortexLake 更快 ✓ |
| **复杂子查询** | 基准 | 0.72x-1.41x | 大多更快，相关子查询除外 |

### 统计汇总

```
22个查询完整测试结果:
- VortexLake 更快 (>1.0x): 20 个 (91%)
- Parquet 更快 (<1.0x): 2 个 (9%) — Q13 (0.89x), Q17 (0.72x)

VortexLake 最大优势: Q19 (2.27x), Q12 (2.08x), Q6 (1.65x)
VortexLake 最大劣势: Q17 (0.72x), Q13 (0.89x)

按表数分类:
- 单表查询 (1表): 2个 — 1.09x, 1.65x
- 2表查询 (2表): 7个 — 1.08x-2.27x
- 3-4表查询: 7个 — 1.08x-1.41x
- 5+表查询: 6个 — 1.12x-1.34x
```

## 后续优化方向

1. **写入性能**: 优化压缩流程，减少写入延迟
2. **相关子查询**: 改进 correlated subquery 执行效率
3. **LEFT JOIN**: 优化外连接场景性能

