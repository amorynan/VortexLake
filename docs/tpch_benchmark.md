# VortexLake TPC-H Benchmark (2025-11-28)

## 概述

本文档记录 VortexLake 与 Parquet 在 TPC-H 基准测试中的性能对比。TPC-H 是决策支持系统的行业标准基准测试，包含 8 个表和 22 个分析查询。

> 通用模型、表结构、查询 SQL 及运行方式请参见 [tpch_benchmark_common.md](tpch_benchmark_common.md)。

## 测试环境

- **数据规模**: Scale Factor 0.1 (约 60MB 原始数据)
- **数据格式**: 
  - Parquet (Apache Parquet, 默认压缩)
  - VortexLake (Apache Vortex 格式, FastLanes + Bitpacking)
- **查询引擎**: Apache DataFusion 50.x
- **测试日期**: 2025-11-28

## 存储性能

| 格式 | 大小 | 压缩比 | 写入时间 |
|------|------|--------|----------|
| Parquet | 54.85 MB | 1.00x | 6,285 ms |
| VortexLake | 27.69 MB | **0.50x** | 18,825 ms |

**结论**: VortexLake 存储空间节省 **50%**，但写入时间较长（约 3x）。

## 测试结果 (SF=0.1)

### 数据规模

| 表 | 行数 |
|----|------|
| region | 5 |
| nation | 25 |
| supplier | 1,000 |
| customer | 15,000 |
| part | 20,000 |
| partsupp | 80,000 |
| orders | 150,000 |
| lineitem | 600,572 |

### 存储性能

| 指标 | Parquet | VortexLake | 比值 |
|------|---------|------------|------|
| **存储大小** | 54.85 MB | 27.69 MB | **0.50x** ✓ |
| **写入时间** | 6,238 ms | 18,685 ms | 3.0x |

### 已测试查询 (15个)

| Query | 描述 | 涉及表数 | Parquet (ms) | VortexLake (ms) | Speedup | 状态 |
|-------|------|---------|-------------|-----------------|---------|------|
| **Q1** | 价格汇总 | 1 | 1,402 | 1,376 | **1.02x** | ✓ PASS |
| **Q6** | 收入预测 | 1 | 375 | 416 | 0.90x | ✓ PASS |
| **Q12** | 配送模式 | 2 | 2,316 | 1,489 | **1.56x** | ✓ PASS |
| **Q14** | 促销效果 | 2 | 1,968 | 413 | **4.76x** 🚀 | ✓ PASS |
| **Q19** | 折扣收入 | 2 | 844 | 724 | **1.16x** | ✓ PASS |
| **Q3** | 配送优先级 | 3 | 626 | 1,534 | 0.41x | ✓ PASS |
| **Q11** | 重要库存识别 | 3 | 357 | 506 | 0.70x | ✓ PASS |
| **Q15** | 顶级供应商 | 2 | 698 | 841 | 0.83x | ✓ PASS |
| **Q18** | 大订单客户 | 3 | 4,748 | 2,480 | **1.91x** | ✓ PASS |
| **Q4** | 订单优先级 | 2 | 458 | 493 | 0.93x | ✓ PASS |
| **Q10** | 退货报告 | 4 | 772 | 968 | 0.80x | ✓ PASS |
| **Q17** | 小订单收入 | 2 | 794 | 1,511 | 0.53x | ✓ PASS |
| **Q5** | 本地供应商 | 6 | 682 | 1,817 | 0.38x | ✓ PASS |
| **Q7** | 体量运输 | 5 | 4,384 | 2,149 | **2.04x** | ✓ PASS |
| **Q9** | 产品利润 | 6 | 6,033 | 2,182 | **2.77x** 🚀 | ✓ PASS |

### 性能分类

#### VortexLake 显著更快 (>1.5x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q14 | **4.76x** | 2表JOIN + CASE聚合 |
| Q9 | **2.77x** | 6表JOIN + LIKE过滤 |
| Q7 | **2.04x** | 5表JOIN + 年份聚合 |
| Q18 | **1.91x** | IN子查询 + 聚合 |
| Q12 | **1.56x** | 2表JOIN + 条件聚合 |

#### VortexLake 略快或相当 (0.9x-1.5x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q19 | 1.16x | 复杂OR条件 |
| Q1 | 1.02x | 单表聚合 |
| Q4 | 0.93x | EXISTS子查询 |
| Q6 | 0.90x | 单表过滤 |

#### Parquet 更快 (<0.9x)
| Query | Speedup | 特点 |
|-------|---------|------|
| Q15 | 0.83x | CTE查询 |
| Q10 | 0.80x | 4表JOIN |
| Q11 | 0.70x | HAVING子查询 |
| Q17 | 0.53x | 相关子查询 |
| Q3 | 0.41x | 3表JOIN |
| Q5 | 0.38x | 6表JOIN (最慢) |

### 完整测试结果 (22个查询全部完成)

| Query | 描述 | 涉及表数 | Parquet (ms) | VortexLake (ms) | Speedup | 状态 |
|-------|------|---------|-------------|-----------------|---------|------|
| **Q1** | 价格汇总 | 1 | 1,421 | 1,397 | **1.02x** | ✓ PASS |
| **Q6** | 收入预测 | 1 | 370 | 419 | 0.88x | ✓ PASS |
| **Q12** | 配送模式 | 2 | 2,310 | 1,465 | **1.58x** | ✓ PASS |
| **Q14** | 促销效果 | 2 | 1,949 | 419 | **4.66x** 🚀 | ✓ PASS |
| **Q19** | 折扣收入 | 2 | 820 | 744 | **1.10x** | ✓ PASS |
| **Q16** | 零件/供应商关系 | 2 | 370 | 493 | 0.75x | ✓ PASS |
| **Q3** | 配送优先级 | 3 | 631 | 1,539 | 0.41x | ✓ PASS |
| **Q11** | 重要库存识别 | 3 | 357 | 498 | 0.72x | ✓ PASS |
| **Q15** | 顶级供应商 | 2 | 691 | 840 | 0.82x | ✓ PASS |
| **Q18** | 大订单客户 | 3 | 4,703 | 2,424 | **1.94x** | ✓ PASS |
| **Q20** | 潜在零件促销 | 2 | 607 | 840 | 0.72x | ✓ PASS |
| **Q21** | 供应商等待 | 4 | 1,652 | 2,779 | 0.59x | ✓ PASS |
| **Q4** | 订单优先级 | 2 | 450 | 500 | 0.90x | ✓ PASS |
| **Q10** | 退货报告 | 4 | 766 | 965 | 0.79x | ✓ PASS |
| **Q17** | 小订单收入 | 2 | 790 | 1,438 | 0.55x | ✓ PASS |
| **Q13** | 客户分布 | 2 | 489 | 568 | 0.86x | ✓ PASS |
| **Q22** | 全球销售机会 | 2 | 229 | 284 | 0.81x | ✓ PASS |
| **Q2** | 最低成本供应商 | 5 | 450 | 678 | 0.66x | ✓ PASS |
| **Q5** | 本地供应商 | 6 | 665 | 1,756 | 0.38x | ✓ PASS |
| **Q7** | 体量运输 | 5 | 4,346 | 2,145 | **2.03x** | ✓ PASS |
| **Q8** | 国家市场份额 | 7 | 2,550 | 1,805 | **1.41x** | ✓ PASS |
| **Q9** | 产品利润 | 6 | 5,961 | 2,150 | **2.77x** 🚀 | ✓ PASS |

## 性能分析

### VortexLake 显著优势场景 (>1.5x)

| Query | Speedup | 分析 |
|-------|---------|------|
| **Q14** | 4.66x | CASE聚合 + 日期范围过滤，Zone Map 高效剪枝 |
| **Q9** | 2.77x | 6表JOIN + LIKE过滤，压缩减少I/O |
| **Q7** | 2.03x | 5表JOIN + 日期范围过滤，谓词下推效果好 |
| **Q18** | 1.94x | IN子查询 + 聚合，压缩优势 |
| **Q12** | 1.58x | 条件聚合 + 日期范围，Zone Map 生效 |
| **Q8** | 1.41x | 7表JOIN但有大范围过滤，压缩优势明显 |

**共同特点**: 
- 有明确的过滤条件（日期范围、LIKE、IN等）
- Zone Map 可以有效剪枝
- 聚合操作受益于压缩
- 多表JOIN时，压缩带来的I/O减少超过JOIN开销

### VortexLake 劣势场景 (<0.9x)

| Query | Speedup | 分析 |
|-------|---------|------|
| **Q5** | 0.38x | 6表JOIN，vortex-datafusion JOIN 优化不足 |
| **Q3** | 0.41x | 3表JOIN，无法有效利用 Zone Map |
| **Q17** | 0.55x | 相关子查询，每行都需要子查询 |
| **Q21** | 0.59x | EXISTS + NOT EXISTS，复杂嵌套查询 |
| **Q2** | 0.66x | 5表JOIN + 相关子查询 |
| **Q11** | 0.72x | HAVING + 子查询，复杂执行计划 |
| **Q20** | 0.72x | 多层嵌套子查询 |
| **Q16** | 0.75x | NOT IN 子查询 |
| **Q10** | 0.79x | 4表JOIN |
| **Q22** | 0.81x | NOT EXISTS + 子查询 |
| **Q15** | 0.82x | CTE查询 |

**共同特点**:
- 多表 JOIN 操作（3-6表）
- 相关子查询或嵌套子查询
- EXISTS/NOT EXISTS 操作
- 无法有效利用谓词下推

### 综合评估

| 方面 | Parquet | VortexLake | 结论 |
|------|---------|------------|------|
| **存储效率** | 54.85 MB | 27.69 MB | VortexLake 节省 **50%** 空间 ✓ |
| **写入性能** | 6.3s | 18.8s | Parquet 快 3x |
| **单表查询** | 基准 | 0.88x-1.02x | 性能相当 |
| **2表JOIN** | 基准 | 0.75x-4.66x | VortexLake 平均更快 ✓ |
| **3-4表JOIN** | 基准 | 0.41x-0.90x | Parquet 更快 |
| **5+表JOIN** | 基准 | 0.38x-2.77x | 取决于过滤条件 |
| **复杂子查询** | 基准 | 0.55x-0.86x | Parquet 更快 |

### 统计汇总

```
22个查询完整测试结果:
- VortexLake 更快 (>1.0x): 8 个 (36%)
- 基本持平 (0.9x-1.0x): 3 个 (14%)
- Parquet 更快 (<0.9x): 11 个 (50%)

VortexLake 最大优势: Q14 (4.66x), Q9 (2.77x), Q7 (2.03x)
VortexLake 最大劣势: Q5 (0.38x), Q3 (0.41x), Q17 (0.55x)

按表数分类:
- 单表查询 (1表): 2个 - 平均 0.95x (基本持平)
- 2表查询 (2表): 9个 - 平均 1.15x (VortexLake 略优)
- 3-4表查询: 6个 - 平均 0.70x (Parquet 更快)
- 5+表查询: 5个 - 平均 1.20x (VortexLake 更快，得益于压缩)
```

## 后续优化方向

1. **JOIN 性能优化**: 改进 vortex-datafusion 的 JOIN 策略
2. **谓词下推**: 增强 Zone Map 过滤能力
3. **并行扫描**: 优化多 fragment 并行读取
4. **写入性能**: 优化压缩流程，减少写入延迟
5. **完整 TPC-H**: 实现剩余 14 个查询的测试

